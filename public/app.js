// ุงูุงุชุตุงู ุจุงูุฎุงุฏู
const socket = io();

// ุนูุงุตุฑ DOM
const loginScreen = document.getElementById('login-screen');
const roomScreen = document.getElementById('room-screen');
const usernameInput = document.getElementById('username');
const roomIdInput = document.getElementById('room-id');
const joinBtn = document.getElementById('join-btn');
const leaveBtn = document.getElementById('leave-btn');
const muteBtn = document.getElementById('mute-btn');
const copyLinkBtn = document.getElementById('copy-link-btn');
const usersList = document.getElementById('users-list');
const currentRoomIdSpan = document.getElementById('current-room-id');
const userCountSpan = document.getElementById('user-count');
const connectionStatus = document.getElementById('connection-status');
const statusText = document.getElementById('status-text');

// ูุชุบูุฑุงุช ุงูุญุงูุฉ
let localStream = null;
let peers = new Map(); // Map of userId -> RTCPeerConnection
let isMuted = false;
let currentRoomId = null;
let currentUsername = null;

// ุฅุนุฏุงุฏุงุช WebRTC
const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// ุงูุงูุถูุงู ุฅูู ุงูุบุฑูุฉ
joinBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    const roomId = roomIdInput.value.trim() || generateRoomId();

    if (!username) {
        alert('ูู ูุถูู ุฃุฏุฎู ุงุณูู!');
        return;
    }

    currentUsername = username;
    currentRoomId = roomId;

    try {
        // ุทูุจ ุงููุตูู ุฅูู ุงููููุฑูููู
        localStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }, 
            video: false 
        });

        // ุงูุงูุถูุงู ุฅูู ุงูุบุฑูุฉ
        socket.emit('join-room', roomId, username);

        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        currentRoomIdSpan.textContent = roomId;
        loginScreen.classList.remove('active');
        roomScreen.classList.add('active');

        updateStatus('connected', 'ูุชุตู');

        // ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงูู ุฅูู ุงููุงุฆูุฉ
        addUserToList('me', username + ' (ุฃูุช)', false, true);

    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงููุตูู ุฅูู ุงููููุฑูููู:', error);
        alert('ูุดู ุงููุตูู ุฅูู ุงููููุฑูููู! ุชุฃูุฏ ูู ุงูุณูุงุญ ุจุงููุตูู ูููููุฑูููู.');
    }
});

// ูุบุงุฏุฑุฉ ุงูุบุฑูุฉ
leaveBtn.addEventListener('click', () => {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงููุบุงุฏุฑุฉุ')) {
        leaveRoom();
    }
});

// ูุชู/ุฅูุบุงุก ูุชู ุงูุตูุช
muteBtn.addEventListener('click', () => {
    if (!localStream) return;

    isMuted = !isMuted;
    localStream.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
    });

    muteBtn.classList.toggle('active', isMuted);
    const icon = muteBtn.querySelector('.icon');
    const text = muteBtn.querySelector('.text');
    
    if (isMuted) {
        icon.textContent = '๐';
        text.textContent = 'ุฅูุบุงุก ุงููุชู';
    } else {
        icon.textContent = '๐ค';
        text.textContent = 'ูุชู ุงูุตูุช';
    }

    // ุฅุฎุจุงุฑ ุงูุขุฎุฑูู
    socket.emit('toggle-mute', isMuted);

    // ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงูู
    updateUserStatus('me', isMuted);
});

// ูุณุฎ ุฑุงุจุท ุงูุบุฑูุฉ
copyLinkBtn.addEventListener('click', () => {
    const url = `${window.location.origin}?room=${currentRoomId}`;
    navigator.clipboard.writeText(url).then(() => {
        const originalText = copyLinkBtn.querySelector('.text').textContent;
        copyLinkBtn.querySelector('.text').textContent = 'ุชู ุงููุณุฎ! โ';
        setTimeout(() => {
            copyLinkBtn.querySelector('.text').textContent = originalText;
        }, 2000);
    });
});

// ูุนุงูุฌ ุงูุฃุญุฏุงุซ ูู ุงูุฎุงุฏู
socket.on('existing-users', async (users) => {
    console.log('ุงููุณุชุฎุฏููู ุงูุญุงูููู:', users);
    
    for (const user of users) {
        await createPeerConnection(user.userId, user.username, true);
    }
});

socket.on('user-connected', async (data) => {
    console.log('ูุณุชุฎุฏู ุฌุฏูุฏ:', data.username);
    addUserToList(data.userId, data.username, false, false);
    await createPeerConnection(data.userId, data.username, false);
});

socket.on('user-disconnected', (data) => {
    console.log('ูุณุชุฎุฏู ุบุงุฏุฑ:', data.username);
    removeUserFromList(data.userId);
    
    if (peers.has(data.userId)) {
        peers.get(data.userId).close();
        peers.delete(data.userId);
    }
});

socket.on('offer', async (data) => {
    console.log('ุงุณุชูุจุงู ุนุฑุถ ูู:', data.username);
    
    if (!peers.has(data.sender)) {
        await createPeerConnection(data.sender, data.username, false);
    }
    
    const peer = peers.get(data.sender);
    await peer.setRemoteDescription(new RTCSessionDescription(data.offer));
    
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    
    socket.emit('answer', {
        answer: answer,
        target: data.sender
    });
});

socket.on('answer', async (data) => {
    console.log('ุงุณุชูุจุงู ุฅุฌุงุจุฉ ูู:', data.sender);
    
    const peer = peers.get(data.sender);
    if (peer) {
        await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
});

socket.on('ice-candidate', async (data) => {
    const peer = peers.get(data.sender);
    if (peer && data.candidate) {
        await peer.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
});

socket.on('user-count', (count) => {
    userCountSpan.textContent = count;
});

socket.on('user-muted', (data) => {
    updateUserStatus(data.userId, data.isMuted);
});

// ุฅูุดุงุก ุงุชุตุงู WebRTC ูุน ูุณุชุฎุฏู ุขุฎุฑ
async function createPeerConnection(userId, username, isInitiator) {
    const peer = new RTCPeerConnection(configuration);
    peers.set(userId, peer);

    // ุฅุถุงูุฉ ุงููุณุงุฑ ุงูุตูุชู ุงููุญูู
    localStream.getTracks().forEach(track => {
        peer.addTrack(track, localStream);
    });

    // ุงุณุชูุจุงู ุงููุณุงุฑ ุงูุตูุชู ูู ุงูุทุฑู ุงูุขุฎุฑ
    peer.ontrack = (event) => {
        console.log('ุงุณุชูุจุงู ุตูุช ูู:', username);
        const audio = new Audio();
        audio.srcObject = event.streams[0];
        audio.play().catch(e => console.error('ุฎุทุฃ ูู ุชุดุบูู ุงูุตูุช:', e));
    };

    // ICE candidates
    peer.onicecandidate = (event) => {
        if (event.candidate) {
            socket.emit('ice-candidate', {
                candidate: event.candidate,
                target: userId
            });
        }
    };

    // ูุนุงูุฌุฉ ุชุบููุฑ ุญุงูุฉ ุงูุงุชุตุงู
    peer.onconnectionstatechange = () => {
        console.log(`ุญุงูุฉ ุงูุงุชุตุงู ูุน ${username}:`, peer.connectionState);
        
        if (peer.connectionState === 'connected') {
            console.log(`ูุชุตู ุจูุฌุงุญ ูุน ${username}`);
        } else if (peer.connectionState === 'failed' || peer.connectionState === 'disconnected') {
            console.log(`ูุดู ุงูุงุชุตุงู ูุน ${username}`);
        }
    };

    // ุฅูุดุงุก ูุฅุฑุณุงู ุงูุนุฑุถ ุฅุฐุง ููุช ุงููุจุงุฏุฑ
    if (isInitiator) {
        addUserToList(userId, username, false, false);
        
        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        
        socket.emit('offer', {
            offer: offer,
            target: userId
        });
    }

    return peer;
}

// ุฅุถุงูุฉ ูุณุชุฎุฏู ุฅูู ุงููุงุฆูุฉ
function addUserToList(userId, username, isMuted, isMe) {
    const userItem = document.createElement('div');
    userItem.className = 'user-item';
    userItem.id = `user-${userId}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'user-avatar';
    avatar.textContent = username.charAt(0).toUpperCase();
    
    const userInfo = document.createElement('div');
    userInfo.className = 'user-info';
    
    const userName = document.createElement('div');
    userName.className = 'user-name';
    userName.textContent = username;
    
    const userStatus = document.createElement('div');
    userStatus.className = 'user-status';
    userStatus.textContent = isMuted ? '๐ ููุชูู' : '๐ค ูุดุท';
    
    userInfo.appendChild(userName);
    userInfo.appendChild(userStatus);
    
    userItem.appendChild(avatar);
    userItem.appendChild(userInfo);
    
    if (isMe) {
        usersList.insertBefore(userItem, usersList.firstChild);
    } else {
        usersList.appendChild(userItem);
    }
}

// ุฅุฒุงูุฉ ูุณุชุฎุฏู ูู ุงููุงุฆูุฉ
function removeUserFromList(userId) {
    const userItem = document.getElementById(`user-${userId}`);
    if (userItem) {
        userItem.remove();
    }
}

// ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู (ููุชูู/ูุดุท)
function updateUserStatus(userId, isMuted) {
    const userItem = document.getElementById(`user-${userId}`);
    if (userItem) {
        const statusElement = userItem.querySelector('.user-status');
        statusElement.textContent = isMuted ? '๐ ููุชูู' : '๐ค ูุดุท';
        statusElement.className = isMuted ? 'user-status muted' : 'user-status';
    }
}

// ุชุญุฏูุซ ุญุงูุฉ ุงูุงุชุตุงู
function updateStatus(status, text) {
    connectionStatus.className = `status-dot ${status}`;
    statusText.textContent = text;
}

// ูุบุงุฏุฑุฉ ุงูุบุฑูุฉ
function leaveRoom() {
    // ุฅููุงู ุฌููุน ุงูุงุชุตุงูุงุช
    peers.forEach(peer => peer.close());
    peers.clear();
    
    // ุฅููุงู ุงููุณุงุฑ ุงูุตูุชู ุงููุญูู
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    // ูุทุน ุงูุงุชุตุงู ูู ุงูุฎุงุฏู
    socket.disconnect();
    
    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
    window.location.reload();
}

// ุชูููุฏ ุฑูู ุบุฑูุฉ ุนุดูุงุฆู
function generateRoomId() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

// ุงูุชุญูู ูู ุฑูู ุงูุบุฑูุฉ ูู ุฑุงุจุท URL
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const roomFromUrl = urlParams.get('room');
    
    if (roomFromUrl) {
        roomIdInput.value = roomFromUrl;
    }
});

// ูุนุงูุฌุฉ ุฅุบูุงู ุงููุงูุฐุฉ
window.addEventListener('beforeunload', () => {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
});

